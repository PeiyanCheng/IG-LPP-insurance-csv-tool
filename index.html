<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>LPP Insurance Illustration → CSV</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; font-size: 13px; }
    table { border-collapse: collapse; font-size: 12px; }
    th, td { border: 1px solid #ccc; padding: 4px; }
    .highlight { background: #fff3cd; }
    .log { border: 1px solid #ccc; padding: 6px; margin: 6px 0; }
    .explain { font-size: 11px; color: #444; }
    .badge { display:inline-block; padding:2px 6px; background:#e3f2fd; margin-left:6px; }
  </style>
</head>

<body>

<h2>LPP Insurance Illustration → CSV</h2>

<input type="file" id="fileInput" />
<button onclick="processFile()">Process</button>
<button onclick="downloadCSV()" id="downloadBtn" disabled>
  Confirm & Download CSV
</button>

<div id="productInfo" style="margin:10px 0;"></div>
<div id="warnings" style="margin:10px 0;"></div>

<!-- ================= Rule Editor ================= -->
<h3>Field Matching Rules (Editable)</h3>
<p class="explain">
Each field uses keyword-based semantic matching.<br>
Monthly values are automatically annualized (×12).
</p>

<table id="ruleTable">
  <tr>
    <th>LPP Field</th>
    <th>Keywords (space separated)</th>
  </tr>
</table>

<!-- ================= Preview ================= -->
<div style="display:flex; gap:20px; margin-top:20px;">
  <div style="width:50%;">
    <h3>Original Illustration (Matched Columns)</h3>
    <div id="originalPreview"></div>
  </div>
  <div style="width:50%;">
    <h3>LPP Template (Preview)</h3>
    <div id="csvPreview"></div>
  </div>
</div>

<h3>Match Explanation</h3>
<div id="explainArea"></div>

<h3>Processing Log</h3>
<div id="logArea"></div>

<script>
/* =====================================================
   1. CONFIGURATION
===================================================== */

const TEMPLATE_HEADERS = [
  "Annual premium",
  "Cash surrender value",
  "Death benefit",
  "Adjusted cost basis",
  "CDA credit",
  "Dividends paid in cash",
  "Taxable portion of dividends",
  "Net cost of pure insurance",
  "Premiums paid by policy"
];

const DEFAULT_RULES = {
  "Annual premium": "premium",
  "Death benefit": "death benefit payout",
  "Cash surrender value": "cash value surrender",
  "Adjusted cost basis": "acb cost basis",
  "CDA credit": "cda credit",
  "Dividends paid in cash": "dividend cash",
  "Taxable portion of dividends": "taxable dividend",
  "Net cost of pure insurance": "cost insurance",
  "Premiums paid by policy": "premium dividend"
};

/* =====================================================
   2. STATE
===================================================== */

let processedRows = [];
let matchedIndexes = [];
let explanations = [];

/* =====================================================
   3. INIT
===================================================== */

window.onload = () => {
  const table = document.getElementById("ruleTable");
  Object.entries(DEFAULT_RULES).forEach(([field, rule]) => {
    const r = table.insertRow();
    r.insertCell().innerText = field;
    r.insertCell().innerHTML =
      `<input style="width:100%" value="${rule}">`;
  });
};

/* =====================================================
   4. HELPERS
===================================================== */

const norm = t => t.toLowerCase().replace(/\s+/g, " ").trim();

function headerMatches(header, keywords) {
  const h = norm(header);
  return keywords.every(k => h.includes(k));
}

function detectProduct(headers) {
  const h = headers.map(norm).join(" ");
  if (h.includes("cash value") || h.includes("cda") || h.includes("acb")) {
    return "Whole Life / UL";
  }
  return "Term";
}

/* =====================================================
   5. CORE LOGIC
===================================================== */

function processFile() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return;

  matchedIndexes = [];
  explanations = [];
  processedRows = [];

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "binary" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const headers = data[0];
    const rows = data.slice(1);
    const productType = detectProduct(headers);

    document.getElementById("productInfo").innerHTML =
      `<b>Detected product type:</b> ${productType}`;

    const rules = {};
    const ruleRows = document.getElementById("ruleTable").rows;
    for (let i = 1; i < ruleRows.length; i++) {
      rules[ruleRows[i].cells[0].innerText] =
        ruleRows[i].cells[1].querySelector("input").value
          .split(" ")
          .map(norm);
    }

    processedRows = rows.map(row => {
      const out = {};
      TEMPLATE_HEADERS.forEach(target => {
        let idx = headers.findIndex(h =>
          headerMatches(h, rules[target] || [])
        );

        if (idx !== -1) {
          let val = row[idx];
          const headerText = headers[idx];
          matchedIndexes.push(idx);

          let explanation = `${target} ← "${headerText}" (keyword match: ${rules[target].join(", ")})`;

          if (norm(headerText).includes("monthly") && !isNaN(val)) {
            val = Number(val) * 12;
            explanation += " | unit: monthly → annual";
          }

          explanations.push(explanation);
          out[target] = val;
        } else {
          out[target] = "";
        }
      });
      return out;
    });

    render(headers, rows);
    renderExplanation();
    logRun(file.name, productType);
    document.getElementById("downloadBtn").disabled = false;
  };
  reader.readAsBinaryString(file);
}

/* =====================================================
   6. UI RENDER
===================================================== */

function render(headers, rows) {
  let left = "<table><tr>";
  headers.forEach((h, i) => {
    if (matchedIndexes.includes(i)) {
      left += `<th class="highlight">${h}</th>`;
    }
  });
  left += "</tr>";

  rows.slice(0, 10).forEach(r => {
    left += "<tr>";
    headers.forEach((_, i) => {
      if (matchedIndexes.includes(i)) {
        left += `<td class="highlight">${r[i]}</td>`;
      }
    });
    left += "</tr>";
  });
  left += "</table>";

  document.getElementById("originalPreview").innerHTML = left;

  let right = "<table><tr>";
  TEMPLATE_HEADERS.forEach(h => right += `<th>${h}</th>`);
  right += "</tr>";

  processedRows.slice(0, 10).forEach(r => {
    right += "<tr>";
    TEMPLATE_HEADERS.forEach(h => right += `<td>${r[h]}</td>`);
    right += "</tr>";
  });
  right += "</table>";

  document.getElementById("csvPreview").innerHTML = right;
}

function renderExplanation() {
  document.getElementById("explainArea").innerHTML =
    [...new Set(explanations)].map(e => `<div class="log">${e}</div>`).join("");
}

/* =====================================================
   7. LOG & DOWNLOAD
===================================================== */

function logRun(name, product) {
  document.getElementById("logArea").innerHTML =
    `<div class="log">
      File: ${name}<br>
      Product type: ${product}<br>
      Rows processed: ${processedRows.length}
    </div>`;
}

function downloadCSV() {
  let csv = TEMPLATE_HEADERS.join(",") + "\n";
  processedRows.forEach(r => {
    csv += TEMPLATE_HEADERS.map(h => r[h]).join(",") + "\n";
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "LPP-Updated.csv";
  a.click();
}
</script>

</body>
</html>
