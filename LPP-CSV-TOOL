<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Insurance Illustration ‚Üí LPP Standardized CSV</title>

<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
    /* =========================================
       INTERNAL STYLES (Specific to this page)
       ========================================= */
    
    /* Action Bar: Holds the Upload and Download buttons */
    .action-bar {
        display: flex; justify-content: space-between; align-items: center;
        gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
    }
    
    /* Hides the ugly default file input button */
    .file-input { display: none; }
    
    /* File Tabs Area */
    .file-tabs { display: flex; gap: 8px; margin-bottom: 18px; flex-wrap: wrap; }
    
    /* Individual Tab Styling */
    .file-tab { 
        padding: 6px 14px; border-radius: 14px; font-size: 12px; 
        cursor: pointer; background: #e0e0e0; transition: 0.2s;
    }
    .file-tab.active { background: var(--primary); color: #fff; } /* Active tab is Blue */

    /* Preview Container (Side by Side tables) */
    .preview-flex { display: flex; gap: 24px; margin-bottom: 24px; }
    /* On mobile, stack them vertically */
    @media (max-width: 900px) { .preview-flex { flex-direction: column; } }

    /* Card Containers for tables */
    .card { flex: 1; min-width: 0; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); background: #fff; }
    .card-illustration { background: #f1fbf4; } /* Green tint */
    .card-lpp { background: #f1f7ff; }         /* Blue tint */
    .card-rules { background: #fff; border: 1px solid #eee; }

    /* Highlights columns found in the Excel */
    .highlight { background: #fff7cc; }

    /* Rule Input Styling */
    .rule-row { display: flex; gap: 12px; align-items: center; margin-bottom: 10px; }
    .rule-label { width: 200px; font-weight: 600; font-size: 13px; }
    .rule-input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px; }
</style>
</head>

<body>

<nav class="navbar">
    <a href="index.html" class="nav-brand">
        <span>‚Üê Back to Dashboard</span>
    </a>
    <div class="nav-search">
        <input type="text" placeholder="Go back to search..." disabled style="opacity: 0.6; cursor: not-allowed; background: #eee;">
    </div>
</nav>

<div class="container">

    <div class="page-header">
        <div class="page-title">Insurance Illustration ‚Üí CSV</div>
        <div style="font-size: 14px; color: #666;">Admin tool ‚Äî upload, match, review, export</div>
    </div>

    <div style="margin: 0 auto 28px auto; max-width: 900px; background: #fff; border: 1px solid #e0e3e8; border-radius: 10px; padding: 14px 18px; font-size: 13px; color: #444; line-height: 1.5;">
        <strong>How to use:</strong><br>
        1. Upload one or multiple insurance illustration Excel files.<br>
        2. Compare the original illustration with the LPP standardized preview.<br>
        3. Update the field matching rules below using <code>|</code> for multiple keywords.
    </div>

    <div class="action-bar">
        <label class="btn btn-upload">
            üìÇ Upload illustration files
            <input id="fileInput" class="file-input" type="file" multiple onchange="loadFiles()">
        </label>

        <div>
            <button class="btn btn-primary" onclick="downloadCurrent()">Download current CSV</button>
            <button class="btn btn-primary" onclick="downloadAll()">Download all CSVs</button>
        </div>
    </div>

    <div id="fileTabs" class="file-tabs"></div>

    <div class="preview-flex">
        <div class="card card-illustration">
            <h3 style="margin-top:0">Original illustration</h3>
            <div id="originalPreview" class="table-scroll"></div>
        </div>

        <div class="card card-lpp">
            <h3 style="margin-top:0">LPP standardized preview</h3>
            <div id="csvPreview" class="table-scroll"></div>
        </div>
    </div>

    <div class="card card-rules">
        <h3 style="margin-top:0; margin-bottom: 15px;">Field matching rules</h3>
        <div style="font-size:12px; color:#666; margin-bottom:15px;">
            Use <b>|</b> for OR conditions. Example: <code>death benefit | payout on death</code>
        </div>
        <div id="rulesContainer"></div>
    </div>

</div>

<script>
// CONFIG: These are the exact headers required for the output CSV
const TEMPLATE_FIELDS = [
  "Annual premium", "Cash surrender value", "Death benefit",
  "Adjusted cost basis", "CDA credit", "Dividends paid in cash",
  "Taxable portion of dividends", "Net cost of pure insurance", "Premiums paid by policy"
];

// DEFAULT RULES: Dictionary mapping Field Name -> Search Keywords
let rules = {
  "Annual premium": "total annual policy premium | annualized premium | monthly premium | total annual premium | total yearly premium",
  "Cash surrender value": "cash surrender | total cash value",
  "Death benefit": "death benefit | payout on death | total death",
  "Adjusted cost basis": "acb | adjusted cost basis",
  "CDA credit": "cda | capital dividend",
  "Dividends paid in cash": "dividend cash | cash dividend",
  "Taxable portion of dividends": "taxable dividend",
  "Net cost of pure insurance": "ncpi | net cost of pure insurance",
  "Premiums paid by policy": "premium dividend"
};

// GLOBAL VARIABLES to store file data
let rawFiles = {};
let fileOrder = [];
let currentFile = "";

// HELPER: Normalize text to lowercase for easier matching
const normalize = t => String(t || "").toLowerCase();

// HELPER: Format numbers (ensure 2 decimal places)
const formatNumber = v => {
  const n = Number(v);
  return isNaN(n) ? "0.00" : n.toFixed(2);
};

// ===================================
// 1. LOAD FILES FUNCTION
// ===================================
function loadFiles() {
  const files = document.getElementById("fileInput").files;
  rawFiles = {};
  fileOrder = [];
  currentFile = "";

  // Loop through uploaded files
  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      // Use SheetJS to read the Excel file
      const wb = XLSX.read(e.target.result, { type: "binary" });
      const sheet = wb.Sheets[wb.SheetNames[0]]; // Read first sheet
      const data = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // Convert to Array

      // Store header and rows separately
      rawFiles[file.name] = { headers: data[0], rows: data.slice(1) };
      fileOrder.push(file.name);
      if (!currentFile) currentFile = file.name;

      // Update UI
      renderTabs();
      render();
    };
    reader.readAsBinaryString(file);
  });
  renderRules(); // Draw the rules input boxes
}

// ===================================
// 2. UI RENDER FUNCTIONS
// ===================================

// Renders the Rules Input boxes at the bottom
function renderRules() {
  const c = document.getElementById("rulesContainer");
  c.innerHTML = "";
  TEMPLATE_FIELDS.forEach(f => {
    const row = document.createElement("div");
    row.className = "rule-row";
    row.innerHTML = `
      <div class="rule-label">${f}</div>
      <input class="rule-input" value="${rules[f]}"
        oninput="rules['${f}']=this.value; render();">
    `;
    c.appendChild(row);
  });
}

// Renders the File Tabs (Top of preview)
function renderTabs() {
  const tabs = document.getElementById("fileTabs");
  tabs.innerHTML = "";
  fileOrder.forEach(name => {
    const t = document.createElement("div");
    // Add 'active' class if this is the current file
    t.className = "file-tab" + (name === currentFile ? " active" : "");
    t.innerText = name;
    t.onclick = () => {
      currentFile = name; // Switch file
      renderTabs();       // Re-draw tabs
      render();           // Re-draw tables
    };
    tabs.appendChild(t);
  });
}

// ===================================
// 3. MAIN LOGIC (Matching & Rendering Tables)
// ===================================
function render() {
  const file = rawFiles[currentFile];
  if (!file) return;

  const { headers, rows } = file;
  let matchedIndexes = []; // Keep track of which original columns we used

  // PROCESS DATA: Create the LPP output format
  let outputs = rows.map(r => {
    let out = {};
    TEMPLATE_FIELDS.forEach(field => {
      // Split keywords by "|" and clean whitespace
      const keywords = rules[field].split("|").map(k => k.trim());
      
      // Find which column index in the Excel matches a keyword
      const idx = headers.findIndex(h => keywords.some(k => normalize(h).includes(normalize(k))));
      
      let val = idx >= 0 ? r[idx] : 0;
      
      // SPECIAL LOGIC: If header contains "monthly", multiply by 12
      if (idx >= 0 && normalize(headers[idx]).includes("monthly") && !isNaN(val)) {
        val *= 12;
      }
      out[field] = val || 0;
      
      if (idx >= 0) matchedIndexes.push(idx); // Mark this column as "Found"
    });
    return out;
  });

  // GENERATE HTML FOR ORIGINAL TABLE
  let o = "<table><thead><tr>";
  headers.forEach(h => o += `<th>${h}</th>`);
  o += "</tr></thead><tbody>";
  rows.forEach(r => {
    o += "<tr>";
    // Check if column index (i) was matched, if so, add 'highlight' class
    r.forEach((c,i) => o += `<td class="${matchedIndexes.includes(i) ? "highlight" : ""}">${c ?? ""}</td>`);
    o += "</tr>";
  });
  o += "</tbody></table>";
  document.getElementById("originalPreview").innerHTML = o;

  // GENERATE HTML FOR LPP OUTPUT TABLE
  let l = "<table><thead><tr>";
  TEMPLATE_FIELDS.forEach(h => l += `<th>${h}</th>`);
  l += "</tr></thead><tbody>";
  outputs.forEach(r => {
    l += "<tr>";
    TEMPLATE_FIELDS.forEach(h => l += `<td>${formatNumber(r[h])}</td>`);
    l += "</tr>";
  });
  l += "</tbody></table>";
  document.getElementById("csvPreview").innerHTML = l;
}

// ===================================
// 4. DOWNLOAD FUNCTIONS
// ===================================
function downloadCurrent() { if (currentFile) exportCSV(currentFile); }
function downloadAll() { fileOrder.forEach(exportCSV); }

function exportCSV(name) {
  const rows = rawFiles[name].rows;
  const headers = rawFiles[name].headers;
  
  // Re-run the processing logic to ensure we get the latest rule updates
  let processed = rows.map(r => {
    let out = {};
    TEMPLATE_FIELDS.forEach(field => {
      const keywords = rules[field].split("|").map(k => k.trim());
      const idx = headers.findIndex(h => keywords.some(k => normalize(h).includes(normalize(k))));
      let val = idx >= 0 ? r[idx] : 0;
      if (idx >= 0 && normalize(headers[idx]).includes("monthly") && !isNaN(val)) val *= 12;
      out[field] = val || 0;
    });
    return out;
  });

  // Build CSV String
  let csv = TEMPLATE_FIELDS.join(",") + "\n";
  processed.forEach(r => {
    csv += TEMPLATE_FIELDS.map(h => r[h]).join(",") + "\n";
  });

  // Trigger Download
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
  a.download = `LPP-Updated-${name.replace(/\.[^/.]+$/, "")}.csv`;
  a.click();
}
</script>

</body>
</html>
